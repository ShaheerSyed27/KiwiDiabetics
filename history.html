<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Entry History</title>
    <!-- Include Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js"></script>
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        /* Your existing CSS styles here */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
        }

        /* Updated navbar style */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
            border-bottom: 1px solid lightgrey;
            z-index: 1000;
        }

        .navbar a {
            color: black;
            text-decoration: none;
            font-weight: bold;
            margin: 0 15px;
            padding: 10px 15px;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }

        .navbar a:hover {
            background-color: lightgrey;
            color: white;
        }

        .navbar a.active {
            background-color: grey;
            color: white;
        }

        .content {
            padding-top: 70px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .history-container {
            max-width: 600px;
            margin: 30px auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .history-entry {
            padding: 20px;
            border-bottom: 1px solid #ccc;
            position: relative;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .delete-button, .edit-button, .save-button, .cancel-button {
            position: absolute;
            top: 10px;
            border: none;
            color: white;
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .edit-button {
            right: 130px;
            background-color: #4CAF50;
        }

        .delete-button {
            right: 10px;
            background-color: #ff4d4d;
        }

        .save-button {
            right: 130px;
            background-color: #4CAF50;
            display: none;
        }

        .cancel-button {
            right: 10px;
            background-color: #f0ad4e;
            display: none;
        }

        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
        }

        .edit-form label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .edit-form select, .edit-form input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            font-size: 1em;
        }

        #chart-container {
            margin: 30px auto;
            width: 100%;
            max-width: 600px;
            height: 400px;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #insulin-on-board {
            text-align: center;
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        canvas {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>
    <!-- Fixed Navigation Bar -->
    <div class="navbar">
        <a href="index.html">Tracker</a>
        <a href="history.html" class="active">History</a>
    </div>

    <!-- Main content with padding to prevent overlap with the navbar -->
    <div class="content">
        <h1>History of Entries</h1>

        <div id="chart-container">
            <canvas id="historyChart"></canvas>
        </div>

        <div id="insulin-on-board">
            Total Insulin on Board: <span id="totalInsulin">0</span> units
        </div>

        <div class="history-container" id="historyContainer">
            <!-- Entries will be displayed here -->
        </div>
    </div>

    <script>
        // Include Firebase configuration and initialization
        // Replace the placeholder values with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDnOPUB_2u93a9XyIa3ifLyc7Pq8gD0JzE",
            authDomain: "kiwidiabetics.firebaseapp.com",
            projectId: "kiwidiabetics",
            storageBucket: "kiwidiabetics.appspot.com",
            messagingSenderId: "590676523026",
            appId: "1:590676523026:web:ac1dff738628b2202bc0cb",
            measurementId: "G-KDCWBZQY08"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Initialize Firestore and Auth
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Sign in anonymously
        auth.signInAnonymously()
            .then(() => {
                console.log('Signed in anonymously');
                loadHistory(); // Load history after authentication
            })
            .catch((error) => {
                console.error('Error signing in anonymously:', error);
                document.getElementById('historyContainer').innerHTML = '<p>Error signing in. Please try again later.</p>';
            });

        // Declare variables globally so they can be used across functions
        let dates = [];
        let insulinDoses = [];
        let insulinEntries = []; // To keep track of insulin entries and times
        let historyChart = null; // Chart instance

        // Function to format a Date object to 'YYYY-MM-DDTHH:MM' in local time
        function formatDateTimeLocal(date) {
            const pad = (num) => num.toString().padStart(2, '0');
            const year = date.getFullYear();
            const month = pad(date.getMonth() + 1); // Months are zero-based
            const day = pad(date.getDate());
            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Function to load the stored data from Firestore and display it
        function loadHistory() {
            console.log("Loading history...");
            const userId = auth.currentUser ? auth.currentUser.uid : null;

            db.collection('diabetesData')
            .where('userId', '==', userId)
            .orderBy('timestamp', 'desc')
            .get()
            .then((querySnapshot) => {
                const savedData = [];
                querySnapshot.forEach((doc) => {
                    savedData.push({ id: doc.id, ...doc.data() });
                });
                displayHistory(savedData);
            })
            .catch((error) => {
                console.error("Error getting documents: ", error);
                document.getElementById('historyContainer').innerHTML = '<p>Error loading data.</p>';
            });
        }

        // Function to display the history entries
        function displayHistory(savedData) {
            // The rest of your existing code for displaying entries
            // Functions: generateOptions, toggleEdit, saveEntry, deleteEntry, updateInsulinOnBoard, createChart
            // Copy the corresponding code from your previous implementation
            // Ensure that any references to localStorage are replaced with Firestore operations
            // Also, make sure to adjust any functions if necessary
            // For brevity, not all code is repeated here
            // ...

            // Example of how to call updateInsulinOnBoard and createChart
            updateInsulinOnBoard();
            createChart(dates, insulinDoses);
        }

        // Function definitions for generateOptions, toggleEdit, saveEntry, deleteEntry, updateInsulinOnBoard, createChart
        // Copy these from your previous code and ensure they work with Firestore data
        // ...

    </script>
</body>
</html>
